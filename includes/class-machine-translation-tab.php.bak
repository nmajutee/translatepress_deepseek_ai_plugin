<?php
if ( ! defined( 'ABSPATH' ) ) exit;

class TRP_Machine_Translation_Tab {
    protected $settings;

    public function __construct( $settings ){
        $this->settings = $settings;
    }

    /**
     * Register/load engines.
     */
    public function load_engines(){
        add_filter( 'trp_machine_translation_engines', array( $this, 'register_engines' ), 10 );
        // register settings sanitization and settings group
        add_action( 'admin_init', array( $this, 'register_setting' ) );

        // show admin warnings when necessary (e.g. engine selected but no API key)
        add_action( 'admin_notices', array( $this, 'admin_notices' ) );
    }

    /**
     * Provide engine entries for the settings UI.
     */
    public function register_engines( $engines ){
        $engines[] = array(
            'value' => 'deepseek',
            'label' => __( 'Deep Seek', 'translatepress-multilingual' ),
            'class' => 'TRP_Deepseek_Machine_Translator',
        );

        return $engines;
    }

    /**
     * Register settings and add sanitize callback to prevent enabling auto-translation without API key.
     */
    public function register_setting() {
        if ( function_exists( 'register_setting' ) ) {
            register_setting(
                'trp_machine_translation_settings',
                'trp_machine_translation_settings',
                array( $this, 'sanitize_settings_on_save' )
            );
        }
    }

    /**
     * Sanitize machine translation settings on save.
     * If user enables automatic translation with Deep Seek engine but no API key is present,
     * the setting will be forced to 'no' and a settings error will be shown.
     *
     * @param array $mt_settings raw settings from POST
     * @return array sanitized settings
     */
    public function sanitize_settings_on_save( $mt_settings ) {
        $current = get_option( 'trp_machine_translation_settings', array() );

        // normalize
        $mt_settings = is_array( $mt_settings ) ? $mt_settings : array();

        // if enabling automatic translation, ensure API key present when Deep Seek selected
        if ( isset( $mt_settings['machine-translation'] ) && $mt_settings['machine-translation'] === 'yes' ) {
            $engine = isset( $mt_settings['translation-engine'] ) ? $mt_settings['translation-engine'] : ( isset( $current['translation-engine'] ) ? $current['translation-engine'] : '' );
            $key = isset( $mt_settings['deepseek_api_key'] ) ? trim( $mt_settings['deepseek_api_key'] ) : ( isset( $current['deepseek_api_key'] ) ? trim( $current['deepseek_api_key'] ) : '' );

            if ( $engine === 'deepseek' && empty( $key ) ) {
                add_settings_error(
                    'trp_machine_translation_settings',
                    'trp_missing_deepseek_key',
                    __( 'Deep Seek API key is required to enable automatic translation. Please add it before enabling.', 'translatepress-multilingual' ),
                    'error'
                );
                // force disable for safety
                $mt_settings['machine-translation'] = 'no';
            }
        }

        // allow other sanitization to happen here as needed
        return $mt_settings;
    }

    /**
     * Admin notices: show a site-level warning when Deep Seek engine selected and no key is configured.
     */
    public function admin_notices() {
        $opt = get_option( 'trp_machine_translation_settings', array() );
        if ( isset( $opt['machine-translation'] ) && $opt['machine-translation'] === 'yes' ) {
            $engine = isset( $opt['translation-engine'] ) ? $opt['translation-engine'] : '';
            if ( $engine === 'deepseek' && empty( $opt['deepseek_api_key'] ) ) {
                echo '<div class="notice notice-error"><p>';
                echo esc_html__( 'Automatic translation is enabled but no Deep Seek API key is configured. Go to TranslatePress â†’ Machine translation settings and paste your Deep Seek API key and endpoint.', 'translatepress-multilingual' );
                echo '</p></div>';
            }
        }
    }

    // kept minimal: other UI helpers can remain as before
    public function add_tab_to_navigation() {}
    public function add_submenu_page() {}
}